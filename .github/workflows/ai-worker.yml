name: AI Worker (Claude Code)

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      BRANCH: claude/issue-${{ github.event.issue.number }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code (branch + commit + push only)
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"
          apply_changes: true
          show_full_output: true
          claude_args: "--max-turns 35"
          prompt: |
            You are Claude Code running inside GitHub Actions.

            Use the GitHub event payload for context; do NOT call gh issue view or web APIs.

            Branching rules (non-negotiable):
            - The branch MUST be named exactly: ${{ env.BRANCH }}
            - Create/reset branch:
              git checkout -B "${{ env.BRANCH }}"
            - Do not append timestamps or any suffix.
            - After making changes, commit and push with:
              git push -u origin "${{ env.BRANCH }}" --force-with-lease

            Objective:
            - Implement the requested change from the issue body/comment.
            - Commit and push your changes.
            - Do NOT open a pull request. The workflow will handle PR creation.

      - name: Create PR (workflow-owned)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "Expected branch: ${BRANCH}"

          if ! git ls-remote --exit-code --heads origin "${BRANCH}" >/dev/null 2>&1; then
            echo "Branch ${BRANCH} not found on origin. Nothing to PR."
            exit 0
          fi

          EXISTING="$(gh pr list --head "${BRANCH}" --state open --json number --jq 'length')"
          if [ "${EXISTING}" != "0" ]; then
            echo "PR already exists for ${BRANCH}. Skipping."
            exit 0
          fi

          gh pr create \
            --head "${BRANCH}" \
            --base "main" \
            --title "AI: Issue #${ISSUE_NUMBER}" \
            --body "Automated PR for issue #${ISSUE_NUMBER}.\n\nTriggered via @claude."
          echo "PR created for ${BRANCH}."